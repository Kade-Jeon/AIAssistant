spring:
  application:
    name: AIAssistant
  profiles:
    active: dev
  server:
    port: 8080

  # JDBC Chat Memory 자동 설정 제외 (CustomChatMemoryRepository 사용)
  # CustomChatMemoryRepository가 CHAT_MESSAGE 테이블을 사용하므로 JdbcChatMemoryRepository는 필요 없음
  # PgVectorStore 자동 설정 제외 (VectorStoreConfig에서 커스텀 설정 사용)
  autoconfigure:
    exclude:
      - org.springframework.ai.model.chat.memory.repository.jdbc.autoconfigure.JdbcChatMemoryRepositoryAutoConfiguration
      - org.springframework.ai.vectorstore.pgvector.autoconfigure.PgVectorStoreAutoConfiguration

  # Virtual Thread 설정
  threads:
    virtual:
      enabled: true

  # 프롬프트 / 대화 캐싱 Redis 서버
  data:
    redis:
      host: localhost
      port: 6389
  #      username: default
  #      password: crinity21!

  # RDB (채팅 메모리 영구 저장)
  datasource:
    url: jdbc:postgresql://localhost:54321/aichat
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver

  # schema.sql로 SPRING_AI_CHAT_MEMORY 테이블 생성 (JdbcChatMemoryRepository auto-config 제외 시 필요)
  sql:
    init:
      mode: always
      separator: ";"
      continue-on-error: true # ENUM 타입이 이미 존재하면 무시하고 계속 진행

  # Ollama
  ai:
    ollama:
      base-url: http://192.168.200.199:11434
      embedding:
        options:
          model: qwen3-embedding:0.6b
    # JDBC Chat Memory: CustomChatMemoryRepository 사용 (CHAT_MESSAGE 테이블)
    # JdbcChatMemoryRepository는 사용하지 않으므로 스키마 자동 초기화 비활성화
    chat:
      memory:
        repository:
          jdbc:
            initialize-schema: never
  # Langfuse
  chat:
    observations:
      log-prompt: false      # 프롬프트 내용 로깅 (개인정보 주의)
      log-completion: false  # 응답 내용 로깅

# 기본 애플리케이션 설정
app:
  sse:
    timeout: 1200000  # 기본값: 20분 (밀리초)
  subject-generation:
    timeout-seconds: 30  # 제목 생성 AI 호출 타임아웃(초), 초과 시 질문 앞 36자 사용
  conversation:
    context-limit: 20  # AI 컨텍스트에 포함할 최근 메시지 개수 (MessageChatMemoryAdvisor가 사용)
    cache-limit: 20  # Redis 캐시에 저장할 최대 메시지 개수
    default-limit: 20  # API 기본 조회 개수
    max-limit: 100  # API 최대 조회 개수
  streaming:
    retry:
      max-attempts: 3  # Ollama 스트리밍 호출 최대 재시도 횟수
      initial-backoff-ms: 100  # 첫 재시도 지연 시간(밀리초)
      max-backoff-ms: 2000  # 최대 재시도 지연 시간(밀리초)
  idempotency:
    ttl-hours: 24  # Idempotency-Key 상태 보관 시간(시간)

# OpenTelemetry 설정 (Langfuse는 Traces만 수집하므로 Logs/Metrics 전송 비활성화)
otel:
  resource:
    attributes:
      deployment.environment: ${spring.profiles.active:default}
      service.name: ${spring.application.name}
  logs:
    exporter: none
  metrics:
    exporter: none
  traces:
    exporter: otlp

# 관리용 엔드포인트 설정
management:
  tracing:
    sampling:
      probability: 1.0 # 100% 트레이싱 샘플링 (운영 환경에서는 조절 필요)
  endpoints:
    web:
      exposure:
        include: health,info,metrics,caches  # 캐시 관련 엔드포인트 포함
  endpoint:
    caches:
      enabled: true  # 캐시 상태 확인 엔드포인트 활성화

# 로깅
logging:
  level:
    com.kade.AIAssistant: INFO
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

langfuse:
  public-key: ${LANGFUSE_PUBLIC_KEY}
  secret-key: ${LANGFUSE_SECRET_KEY}
  retry:
    max-attempts: 3   # 5xx(524 등) 시 최대 재시도 횟수, 모두 실패 시 예외 전파
    delay-ms: 2000    # 재시도 전 대기 시간(밀리초)